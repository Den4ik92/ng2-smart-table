import { LocalSorter } from './local.sorter';
import { LocalFilter } from './local.filter';
import { LocalPager } from './local.pager';
import { DataSource } from '../data-source';
import { deepExtend } from '../../helpers';
export class LocalDataSource extends DataSource {
    constructor(data = []) {
        super();
        this.data = [];
        this.filteredAndSorted = [];
        this.sortConf = [];
        this.filterConf = {
            filters: [],
            andOperator: true,
        };
        this.pagingConf = false;
        this.data = data;
    }
    load(data) {
        this.data = data;
        return super.loadEmit();
    }
    prepend(element) {
        this.reset(true);
        this.data.unshift(element);
        return super.prependEmit(element);
    }
    appendMany(elements) {
        this.reset(true);
        this.data = [...this.data, ...elements];
        return super.loadEmit();
    }
    append(element) {
        this.reset(true);
        this.data.push(element);
        return super.appendEmit(element);
    }
    add(element) {
        this.data.push(element);
        return super.addEmit(element);
    }
    remove(element) {
        this.data = this.data.filter(el => el !== element);
        return super.removeEmit(element);
    }
    update(element, values) {
        return new Promise((resolve, reject) => {
            this.find(element).then((found) => {
                found = deepExtend(found, values);
                super.updateEmit(found).then(resolve).catch(reject);
            }).catch(reject);
        });
    }
    find(element) {
        const found = this.data.find(el => el === element);
        if (found) {
            return Promise.resolve(found);
        }
        return Promise.reject(new Error('Element was not found in the dataset'));
    }
    getElements() {
        const data = this.data.slice(0);
        return Promise.resolve(this.prepareData(data));
    }
    getFilteredAndSorted() {
        let data = this.data.slice(0);
        this.prepareData(data);
        return Promise.resolve(this.filteredAndSorted);
    }
    getAll() {
        const data = this.data.slice(0);
        return Promise.resolve(data);
    }
    reset(silent = false) {
        if (silent) {
            this.filterConf = {
                filters: [],
                andOperator: true,
            };
            this.sortConf = [];
            if (this.pagingConf) {
                this.pagingConf.page = 1;
            }
        }
        else {
            this.setFilter([], true, false);
            this.setSort([], false);
            if (this.pagingConf) {
                this.setPage(1);
            }
        }
    }
    empty() {
        this.data = [];
        return super.emptyEmit();
    }
    count() {
        return this.filteredAndSorted.length;
    }
    /**
     *
     * Array of conf objects
     * [
     *  {field: string, direction: asc|desc|null, compare: Function|null},
     * ]
     * @param conf
     * @param doEmit
     * @returns {LocalDataSource}
     */
    setSort(conf, doEmit = true) {
        if (conf !== null) {
            conf.forEach((fieldConf) => {
                if (!fieldConf.field || typeof fieldConf.direction === 'undefined') {
                    throw new Error('Sort configuration object is not valid');
                }
            });
            this.sortConf = conf;
        }
        if (doEmit) {
            super.setSortEmit();
        }
        return this;
    }
    /**
     *
     * Array of conf objects
     * [
     *  {field: string, search: string, filter: Function|null},
     * ]
     * @param conf
     * @param andOperator
     * @param doEmit
     * @returns {LocalDataSource}
     */
    setFilter(conf, andOperator = true, doEmit = true) {
        if (conf && conf.length > 0) {
            conf.forEach((fieldConf) => {
                this.addFilter(fieldConf, andOperator, false);
            });
        }
        else {
            this.filterConf = {
                filters: [],
                andOperator: true,
            };
        }
        this.filterConf.andOperator = andOperator;
        if (this.pagingConf) {
            this.pagingConf.page = 1;
        }
        if (doEmit) {
            super.setFilterEmit();
        }
        return this;
    }
    addFilter(fieldConf, andOperator = true, doEmit = true) {
        if (!fieldConf.field || typeof fieldConf.search === 'undefined') {
            throw new Error('Filter configuration object is not valid');
        }
        let found = false;
        this.filterConf.filters.forEach((currentFieldConf, index) => {
            if (currentFieldConf.field === fieldConf.field) {
                this.filterConf.filters[index] = fieldConf;
                found = true;
            }
        });
        if (!found) {
            this.filterConf.filters.push(fieldConf);
        }
        this.filterConf.andOperator = andOperator;
        if (doEmit) {
            super.addFilterEmit();
        }
        return this;
    }
    setPaging(page = 1, perPage, doEmit = true) {
        if (this.pagingConf) {
            this.pagingConf.page = page;
            this.pagingConf.perPage = perPage;
        }
        else {
            this.pagingConf = {
                page, perPage
            };
        }
        if (doEmit) {
            super.setPagingEmit();
        }
        return;
    }
    setPage(page, doEmit = true) {
        if (!this.pagingConf) {
            return;
        }
        this.pagingConf.page = page;
        if (doEmit) {
            super.setPageEmit();
        }
        return;
    }
    getSort() {
        return this.sortConf;
    }
    getFilter() {
        return this.filterConf;
    }
    getPaging() {
        return this.pagingConf;
    }
    prepareData(data) {
        data = this.filter(data);
        data = this.sort(data);
        this.filteredAndSorted = data.slice(0);
        if (this.pagingConf) {
            return this.paginate(data);
        }
        else
            return data;
    }
    sort(data) {
        if (this.sortConf) {
            this.sortConf.forEach((fieldConf) => {
                data = LocalSorter
                    .sort(data, fieldConf.field, fieldConf.direction, fieldConf.compare);
            });
        }
        return data;
    }
    // TODO: refactor?
    filter(data) {
        if (this.filterConf.filters) {
            if (this.filterConf.andOperator) {
                this.filterConf.filters.forEach((fieldConf) => {
                    if (fieldConf.search?.length > 0) {
                        data = LocalFilter
                            .filter(data, fieldConf.field, fieldConf.search, fieldConf.filter);
                    }
                });
            }
            else {
                let mergedData = [];
                this.filterConf.filters.forEach((fieldConf) => {
                    if (fieldConf.search?.length > 0) {
                        mergedData = mergedData.concat(LocalFilter
                            .filter(data, fieldConf.field, fieldConf.search, fieldConf.filter));
                    }
                });
                // remove non unique items
                data = mergedData.filter((elem, pos, arr) => {
                    return arr.indexOf(elem) === pos;
                });
            }
        }
        return data;
    }
    paginate(data) {
        if (this.pagingConf && this.pagingConf.page && this.pagingConf.perPage) {
            data = LocalPager.paginate(data, this.pagingConf.page, this.pagingConf.perPage);
        }
        return data;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWwuZGF0YS1zb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZzItc21hcnQtdGFibGUvc3JjL2xpYi9saWIvZGF0YS1zb3VyY2UvbG9jYWwvbG9jYWwuZGF0YS1zb3VyY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDLE1BQU0sT0FBTyxlQUF5QixTQUFRLFVBQWE7SUFXekQsWUFBWSxPQUFZLEVBQUU7UUFDeEIsS0FBSyxFQUFFLENBQUM7UUFWQSxTQUFJLEdBQVEsRUFBRSxDQUFDO1FBQ2Ysc0JBQWlCLEdBQVEsRUFBRSxDQUFDO1FBQzVCLGFBQVEsR0FBeUIsRUFBRSxDQUFDO1FBQ3BDLGVBQVUsR0FBeUI7WUFDM0MsT0FBTyxFQUFFLEVBQUU7WUFDWCxXQUFXLEVBQUUsSUFBSTtTQUNsQixDQUFDO1FBQ1EsZUFBVSxHQUFpQyxLQUFLLENBQUM7UUFLekQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVELElBQUksQ0FBQyxJQUFTO1FBQ1osSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsT0FBTyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU8sQ0FBQyxPQUFVO1FBQ2hCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FB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QyxJQUFTO1FBQzFCLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRTtZQUN0RSxJQUFJLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNqRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYWxTb3J0ZXIgfSBmcm9tICcuL2xvY2FsLnNvcnRlcic7XG5pbXBvcnQgeyBMb2NhbEZpbHRlciB9IGZyb20gJy4vbG9jYWwuZmlsdGVyJztcbmltcG9ydCB7IExvY2FsUGFnZXIgfSBmcm9tICcuL2xvY2FsLnBhZ2VyJztcbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICcuLi9kYXRhLXNvdXJjZSc7XG5pbXBvcnQgeyBkZWVwRXh0ZW5kIH0gZnJvbSAnLi4vLi4vaGVscGVycyc7XG5pbXBvcnQgeyBTbWFydFRhYmxlRmlsdGVyQ29uZiwgU21hcnRUYWJsZUZpbHRlckl0ZW0sIFNtYXJ0VGFibGVQYWdpbmdJdGVtLCBTbWFydFRhYmxlU29ydEl0ZW0gfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3NtYXJ0LXRhYmxlLm1vZGVscyc7XG5cbmV4cG9ydCBjbGFzcyBMb2NhbERhdGFTb3VyY2U8VCA9IGFueT4gZXh0ZW5kcyBEYXRhU291cmNlPFQ+IHtcblxuICBwcm90ZWN0ZWQgZGF0YTogVFtdID0gW107XG4gIHByb3RlY3RlZCBmaWx0ZXJlZEFuZFNvcnRlZDogVFtdID0gW107XG4gIHByb3RlY3RlZCBzb3J0Q29uZjogU21hcnRUYWJsZVNvcnRJdGVtW10gPSBbXTtcbiAgcHJvdGVjdGVkIGZpbHRlckNvbmY6IFNtYXJ0VGFibGVGaWx0ZXJDb25mID0ge1xuICAgIGZpbHRlcnM6IFtdLFxuICAgIGFuZE9wZXJhdG9yOiB0cnVlLFxuICB9O1xuICBwcm90ZWN0ZWQgcGFnaW5nQ29uZjogU21hcnRUYWJsZVBhZ2luZ0l0ZW0gfCBmYWxzZSA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKGRhdGE6IFRbXSA9IFtdKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gIH1cblxuICBsb2FkKGRhdGE6IGFueSk6IFByb21pc2U8dHJ1ZT4ge1xuICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgcmV0dXJuIHN1cGVyLmxvYWRFbWl0KCk7XG4gIH1cblxuICBwcmVwZW5kKGVsZW1lbnQ6IFQpOiBQcm9taXNlPHRydWU+IHtcbiAgICB0aGlzLnJlc2V0KHRydWUpO1xuICAgIHRoaXMuZGF0YS51bnNoaWZ0KGVsZW1lbnQpO1xuICAgIHJldHVybiBzdXBlci5wcmVwZW5kRW1pdChlbGVtZW50KTtcbiAgfSAgXG4gIFxuICBhcHBlbmRNYW55KGVsZW1lbnRzOiBUW10pOiBQcm9taXNlPHRydWU+IHtcbiAgICB0aGlzLnJlc2V0KHRydWUpO1xuICAgIHRoaXMuZGF0YSA9IFsuLi50aGlzLmRhdGEsIC4uLmVsZW1lbnRzXTtcbiAgICByZXR1cm4gc3VwZXIubG9hZEVtaXQoKTtcbiAgfVxuXG4gIGFwcGVuZChlbGVtZW50OiBUKTogUHJvbWlzZTx0cnVlPiB7XG4gICAgdGhpcy5yZXNldCh0cnVlKTtcblxuICAgIHRoaXMuZGF0YS5wdXNoKGVsZW1lbnQpO1xuICAgIHJldHVybiBzdXBlci5hcHBlbmRFbWl0KGVsZW1lbnQpO1xuICB9XG5cbiAgYWRkKGVsZW1lbnQ6IFQpOiBQcm9taXNlPHRydWU+IHtcbiAgICB0aGlzLmRhdGEucHVzaChlbGVtZW50KTtcbiAgICByZXR1cm4gc3VwZXIuYWRkRW1pdChlbGVtZW50KTtcbiAgfVxuXG4gIHJlbW92ZShlbGVtZW50OiBUKTogUHJvbWlzZTx0cnVlPiB7XG4gICAgdGhpcy5kYXRhID0gdGhpcy5kYXRhLmZpbHRlcihlbCA9PiBlbCAhPT0gZWxlbWVudCk7XG4gICAgcmV0dXJuIHN1cGVyLnJlbW92ZUVtaXQoZWxlbWVudCk7XG4gIH1cblxuICB1cGRhdGUoZWxlbWVudDogVCwgdmFsdWVzOiBUKTogUHJvbWlzZTx0cnVlPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZmluZChlbGVtZW50KS50aGVuKChmb3VuZCkgPT4ge1xuICAgICAgICBmb3VuZCA9IGRlZXBFeHRlbmQoZm91bmQsIHZhbHVlcyk7XG4gICAgICAgIHN1cGVyLnVwZGF0ZUVtaXQoZm91bmQpLnRoZW4ocmVzb2x2ZSkuY2F0Y2gocmVqZWN0KTtcbiAgICAgIH0pLmNhdGNoKHJlamVjdCk7XG4gICAgfSk7XG4gIH1cblxuICBmaW5kKGVsZW1lbnQ6IFQpOiBQcm9taXNlPFQ+IHtcbiAgICBjb25zdCBmb3VuZCA9IHRoaXMuZGF0YS5maW5kKGVsID0+IGVsID09PSBlbGVtZW50KTtcbiAgICBpZiAoZm91bmQpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZm91bmQpO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdFbGVtZW50IHdhcyBub3QgZm91bmQgaW4gdGhlIGRhdGFzZXQnKSk7XG4gIH1cblxuICBnZXRFbGVtZW50cygpOiBQcm9taXNlPFRbXT4ge1xuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGEuc2xpY2UoMCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLnByZXBhcmVEYXRhKGRhdGEpKTtcbiAgfVxuXG4gIGdldEZpbHRlcmVkQW5kU29ydGVkKCk6IFByb21pc2U8VFtdPiB7XG4gICAgbGV0IGRhdGEgPSB0aGlzLmRhdGEuc2xpY2UoMCk7XG4gICAgdGhpcy5wcmVwYXJlRGF0YShkYXRhKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuZmlsdGVyZWRBbmRTb3J0ZWQpO1xuICB9XG5cbiAgZ2V0QWxsKCk6IFByb21pc2U8VFtdPiB7XG4gICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YS5zbGljZSgwKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRhdGEpO1xuICB9XG5cbiAgcmVzZXQoc2lsZW50ID0gZmFsc2UpIHtcbiAgICBpZiAoc2lsZW50KSB7XG4gICAgICB0aGlzLmZpbHRlckNvbmYgPSB7XG4gICAgICAgIGZpbHRlcnM6IFtdLFxuICAgICAgICBhbmRPcGVyYXRvcjogdHJ1ZSxcbiAgICAgIH07XG4gICAgICB0aGlzLnNvcnRDb25mID0gW107XG4gICAgICBpZiAodGhpcy5wYWdpbmdDb25mKSB7XG4gICAgICAgIHRoaXMucGFnaW5nQ29uZi5wYWdlID0gMTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXRGaWx0ZXIoW10sIHRydWUsIGZhbHNlKTtcbiAgICAgIHRoaXMuc2V0U29ydChbXSwgZmFsc2UpO1xuICAgICAgaWYgKHRoaXMucGFnaW5nQ29uZikge1xuICAgICAgICB0aGlzLnNldFBhZ2UoMSk7XG4gICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGVtcHR5KCk6IFByb21pc2U8dHJ1ZT4ge1xuICAgIHRoaXMuZGF0YSA9IFtdO1xuICAgIHJldHVybiBzdXBlci5lbXB0eUVtaXQoKTtcbiAgfVxuXG4gIGNvdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyZWRBbmRTb3J0ZWQubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIEFycmF5IG9mIGNvbmYgb2JqZWN0c1xuICAgKiBbXG4gICAqICB7ZmllbGQ6IHN0cmluZywgZGlyZWN0aW9uOiBhc2N8ZGVzY3xudWxsLCBjb21wYXJlOiBGdW5jdGlvbnxudWxsfSxcbiAgICogXVxuICAgKiBAcGFyYW0gY29uZlxuICAgKiBAcGFyYW0gZG9FbWl0XG4gICAqIEByZXR1cm5zIHtMb2NhbERhdGFTb3VyY2V9XG4gICAqL1xuICBzZXRTb3J0KGNvbmY6IFNtYXJ0VGFibGVTb3J0SXRlbVtdLCBkb0VtaXQgPSB0cnVlKTogTG9jYWxEYXRhU291cmNlIHtcbiAgICBpZiAoY29uZiAhPT0gbnVsbCkge1xuICAgICAgY29uZi5mb3JFYWNoKChmaWVsZENvbmYpID0+IHtcbiAgICAgICAgaWYgKCFmaWVsZENvbmYuZmllbGQgfHwgdHlwZW9mIGZpZWxkQ29uZi5kaXJlY3Rpb24gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTb3J0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGlzIG5vdCB2YWxpZCcpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ydENvbmYgPSBjb25mO1xuICAgIH1cbiAgICBpZiAoZG9FbWl0KSB7XG4gICAgICBzdXBlci5zZXRTb3J0RW1pdCgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBBcnJheSBvZiBjb25mIG9iamVjdHNcbiAgICogW1xuICAgKiAge2ZpZWxkOiBzdHJpbmcsIHNlYXJjaDogc3RyaW5nLCBmaWx0ZXI6IEZ1bmN0aW9ufG51bGx9LFxuICAgKiBdXG4gICAqIEBwYXJhbSBjb25mXG4gICAqIEBwYXJhbSBhbmRPcGVyYXRvclxuICAgKiBAcGFyYW0gZG9FbWl0XG4gICAqIEByZXR1cm5zIHtMb2NhbERhdGFTb3VyY2V9XG4gICAqL1xuICBzZXRGaWx0ZXIoY29uZjogU21hcnRUYWJsZUZpbHRlckl0ZW1bXSwgYW5kT3BlcmF0b3IgPSB0cnVlLCBkb0VtaXQgPSB0cnVlKTogTG9jYWxEYXRhU291cmNlIHtcbiAgICBpZiAoY29uZiAmJiBjb25mLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbmYuZm9yRWFjaCgoZmllbGRDb25mKSA9PiB7XG4gICAgICAgIHRoaXMuYWRkRmlsdGVyKGZpZWxkQ29uZiwgYW5kT3BlcmF0b3IsIGZhbHNlKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZpbHRlckNvbmYgPSB7XG4gICAgICAgIGZpbHRlcnM6IFtdLFxuICAgICAgICBhbmRPcGVyYXRvcjogdHJ1ZSxcbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMuZmlsdGVyQ29uZi5hbmRPcGVyYXRvciA9IGFuZE9wZXJhdG9yO1xuICAgIGlmICh0aGlzLnBhZ2luZ0NvbmYpIHtcbiAgICAgIHRoaXMucGFnaW5nQ29uZi5wYWdlID0gMTtcbiAgICB9XG4gICAgaWYgKGRvRW1pdCkge1xuICAgICAgc3VwZXIuc2V0RmlsdGVyRW1pdCgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFkZEZpbHRlcihmaWVsZENvbmY6IFNtYXJ0VGFibGVGaWx0ZXJJdGVtLCBhbmRPcGVyYXRvciA9IHRydWUsIGRvRW1pdDogYm9vbGVhbiA9IHRydWUpOiBMb2NhbERhdGFTb3VyY2Uge1xuICAgIGlmICghZmllbGRDb25mLmZpZWxkIHx8IHR5cGVvZiBmaWVsZENvbmYuc2VhcmNoID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGaWx0ZXIgY29uZmlndXJhdGlvbiBvYmplY3QgaXMgbm90IHZhbGlkJyk7XG4gICAgfVxuXG4gICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgdGhpcy5maWx0ZXJDb25mLmZpbHRlcnMuZm9yRWFjaCgoY3VycmVudEZpZWxkQ29uZjogYW55LCBpbmRleDogYW55KSA9PiB7XG4gICAgICBpZiAoY3VycmVudEZpZWxkQ29uZi5maWVsZCA9PT0gZmllbGRDb25mLmZpZWxkKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyQ29uZi5maWx0ZXJzW2luZGV4XSA9IGZpZWxkQ29uZjtcbiAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmICghZm91bmQpIHtcbiAgICAgIHRoaXMuZmlsdGVyQ29uZi5maWx0ZXJzLnB1c2goZmllbGRDb25mKTtcbiAgICB9XG4gICAgdGhpcy5maWx0ZXJDb25mLmFuZE9wZXJhdG9yID0gYW5kT3BlcmF0b3I7XG4gICAgaWYgKGRvRW1pdCkge1xuICAgICAgc3VwZXIuYWRkRmlsdGVyRW1pdCgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldFBhZ2luZyhwYWdlOiBudW1iZXIgPSAxLCBwZXJQYWdlOiBudW1iZXIsIGRvRW1pdDogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wYWdpbmdDb25mKSB7XG4gICAgICB0aGlzLnBhZ2luZ0NvbmYucGFnZSA9IHBhZ2U7XG4gICAgICB0aGlzLnBhZ2luZ0NvbmYucGVyUGFnZSA9IHBlclBhZ2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucGFnaW5nQ29uZiA9IHtcbiAgICAgICAgcGFnZSwgcGVyUGFnZVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoZG9FbWl0KSB7XG4gICAgICBzdXBlci5zZXRQYWdpbmdFbWl0KCk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIHNldFBhZ2UocGFnZTogbnVtYmVyLCBkb0VtaXQ6IGJvb2xlYW4gPSB0cnVlKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnBhZ2luZ0NvbmYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5wYWdpbmdDb25mLnBhZ2UgPSBwYWdlO1xuICAgIGlmKGRvRW1pdCkge1xuICAgICAgc3VwZXIuc2V0UGFnZUVtaXQoKTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgZ2V0U29ydCgpOiBTbWFydFRhYmxlU29ydEl0ZW1bXSB7XG4gICAgcmV0dXJuIHRoaXMuc29ydENvbmY7XG4gIH1cblxuICBnZXRGaWx0ZXIoKTogU21hcnRUYWJsZUZpbHRlckNvbmYge1xuICAgIHJldHVybiB0aGlzLmZpbHRlckNvbmY7XG4gIH1cblxuICBnZXRQYWdpbmcoKTogU21hcnRUYWJsZVBhZ2luZ0l0ZW0gfCBmYWxzZSB7XG4gICAgcmV0dXJuIHRoaXMucGFnaW5nQ29uZjtcbiAgfVxuXG4gIHByb3RlY3RlZCBwcmVwYXJlRGF0YShkYXRhOiBUW10pOiBUW10ge1xuICAgIGRhdGEgPSB0aGlzLmZpbHRlcihkYXRhKTtcbiAgICBkYXRhID0gdGhpcy5zb3J0KGRhdGEpO1xuICAgIHRoaXMuZmlsdGVyZWRBbmRTb3J0ZWQgPSBkYXRhLnNsaWNlKDApO1xuICAgIGlmKHRoaXMucGFnaW5nQ29uZikge1xuICAgICAgcmV0dXJuIHRoaXMucGFnaW5hdGUoZGF0YSk7XG4gICAgfSBlbHNlIHJldHVybiBkYXRhXG4gIH1cblxuICBwcm90ZWN0ZWQgc29ydChkYXRhOiBUW10pOiBUW10ge1xuICAgIGlmICh0aGlzLnNvcnRDb25mKSB7XG4gICAgICB0aGlzLnNvcnRDb25mLmZvckVhY2goKGZpZWxkQ29uZikgPT4ge1xuICAgICAgICBkYXRhID0gTG9jYWxTb3J0ZXJcbiAgICAgICAgICAuc29ydChkYXRhLCBmaWVsZENvbmYuZmllbGQsIGZpZWxkQ29uZi5kaXJlY3Rpb24sIGZpZWxkQ29uZi5jb21wYXJlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIC8vIFRPRE86IHJlZmFjdG9yP1xuICBwcm90ZWN0ZWQgZmlsdGVyKGRhdGE6IFRbXSk6IFRbXSB7XG4gICAgaWYgKHRoaXMuZmlsdGVyQ29uZi5maWx0ZXJzKSB7XG4gICAgICBpZiAodGhpcy5maWx0ZXJDb25mLmFuZE9wZXJhdG9yKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyQ29uZi5maWx0ZXJzLmZvckVhY2goKGZpZWxkQ29uZjogU21hcnRUYWJsZUZpbHRlckl0ZW0pID0+IHtcbiAgICAgICAgICBpZiAoZmllbGRDb25mLnNlYXJjaD8ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZGF0YSA9IExvY2FsRmlsdGVyXG4gICAgICAgICAgICAgIC5maWx0ZXIoZGF0YSwgZmllbGRDb25mLmZpZWxkLCBmaWVsZENvbmYuc2VhcmNoLCBmaWVsZENvbmYuZmlsdGVyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IG1lcmdlZERhdGE6IFRbXSA9IFtdO1xuICAgICAgICB0aGlzLmZpbHRlckNvbmYuZmlsdGVycy5mb3JFYWNoKChmaWVsZENvbmY6IFNtYXJ0VGFibGVGaWx0ZXJJdGVtKSA9PiB7XG4gICAgICAgICAgaWYgKGZpZWxkQ29uZi5zZWFyY2g/Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIG1lcmdlZERhdGEgPSBtZXJnZWREYXRhLmNvbmNhdChMb2NhbEZpbHRlclxuICAgICAgICAgICAgICAuZmlsdGVyKGRhdGEsIGZpZWxkQ29uZi5maWVsZCwgZmllbGRDb25mLnNlYXJjaCwgZmllbGRDb25mLmZpbHRlcikpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIC8vIHJlbW92ZSBub24gdW5pcXVlIGl0ZW1zXG4gICAgICAgIGRhdGEgPSBtZXJnZWREYXRhLmZpbHRlcigoZWxlbTogYW55LCBwb3M6IGFueSwgYXJyOiBhbnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gYXJyLmluZGV4T2YoZWxlbSkgPT09IHBvcztcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhZ2luYXRlKGRhdGE6IFRbXSk6IFRbXSB7XG4gICAgaWYgKHRoaXMucGFnaW5nQ29uZiAmJiB0aGlzLnBhZ2luZ0NvbmYucGFnZSAmJiB0aGlzLnBhZ2luZ0NvbmYucGVyUGFnZSkge1xuICAgICAgZGF0YSA9IExvY2FsUGFnZXIucGFnaW5hdGUoZGF0YSwgdGhpcy5wYWdpbmdDb25mLnBhZ2UsIHRoaXMucGFnaW5nQ29uZi5wZXJQYWdlKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbn1cbiJdfQ==